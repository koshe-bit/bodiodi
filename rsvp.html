<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bodiodi — Reserve</title>

  <!-- Fonts -->
  <link rel="stylesheet" href="https://use.typekit.net/xtw4aqt.css">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&family=Krub:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- Global styles -->
  <link rel="stylesheet" href="assets/global.css?v=1">

  <style>
    main{ padding-top: 96px; } /* topbar offset */

    .page-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }

    .kicker{
      margin:0 0 6px 0;
      font-family:"Inter";
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:800;
      color:var(--dk85);
      opacity:.9;
      font-size:12px;
    }

    .meta{
      margin:0;
      max-width:none;
      font-size:14px;
      opacity:.9;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.55);
      backdrop-filter:saturate(120%) blur(6px);
      -webkit-backdrop-filter:saturate(120%) blur(6px);
      font-size:14px;
      color:var(--dk);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid rgba(0,0,0,.10);
      border-radius:16px;
      padding:14px 14px 12px;
      background:rgba(255,255,255,.72);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }

    .card h3{
      margin:0 0 10px 0;
      font-family:"Inter";
      font-weight:800;
      letter-spacing:-.01em;
      color:var(--dk);
      font-size:22px;
      line-height:1.05;
    }

    .when{
      margin:0 0 12px 0;
      font-size:14px;
      color:var(--dk85);
      opacity:.92;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:10px;
    }

    .btn.small{
      padding:10px 14px;
      letter-spacing:.10em;
      font-size:12px;
      white-space:nowrap;
    }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; z-index:200; }
    .modal.open{ display:block; }
    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .modal-card{
      position:relative;
      width:min(560px, 92vw);
      margin: 14vh auto 0;
      background:#fffaf8;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:18px 18px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.22);
      color:var(--dk);
      font-family:"Krub", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .modal-card h3{
      margin:0 0 10px 0;
      font-family:"Inter";
      font-weight:800;
      letter-spacing:-.01em;
      color:var(--dk);
    }
    .modal-card p{ margin:0 0 10px 0; line-height:1.5; max-width:none; }
    .modal-actions{
      display:flex; gap:10px; justify-content:flex-end;
      margin-top:12px;
    }
    .btn-ghost{
      background:transparent;
      border:2px solid rgba(58,67,60,.35);
      color:var(--dk85);
    }
    .modal-note{
      margin:10px 0 0 0;
      font-size:13px;
      opacity:.82;
    }
  </style>
</head>

<body class="with-topbar">

  <!-- Member topbar (you said keep this slightly lighter look as-is) -->
  <div class="topbar">
    <div class="topbar-inner">
      <p class="brand">
        <img src="bodiodilogo.svg" alt="Bodiodi" class="brand-logo">
      </p>

      <nav class="navlinks">
        <a href="https://bodiodi.com/schedule.html">Schedule</a>
        <a href="https://bodiodi.com/signup.html">Reserve</a>
        <a href="https://bodiodi.com/classes.html">Classes</a>
        <a href="https://bodiodi.com/about.html">About</a>
        <a href="https://bodiodi.com/pricing.html">Pricing</a>
      </nav>

      <button class="menu-btn" id="menuBtn" type="button" aria-expanded="false" aria-controls="drawer" aria-label="Open menu">
        <span class="hamburger" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <nav id="drawer" class="drawer" aria-hidden="true">
    <a href="https://bodiodi.com/schedule.html">Schedule</a>
    <a href="https://bodiodi.com/signup.html">Reserve</a>
    <a href="https://bodiodi.com/classes.html">Classes</a>
    <a href="https://bodiodi.com/about.html">About</a>
    <a href="https://bodiodi.com/pricing.html">Pricing</a>
  </nav>

  <main>
    <div class="page-head">
      <div>
        <p class="kicker">Members</p>
        <h1 style="margin:0;">Reserve your spot</h1>
        <p class="meta">Tap a class, confirm the reminder, and you’re in.</p>
      </div>

      <div class="badge" id="memberBadge">Loading member…</div>
    </div>

    <div class="rule" aria-hidden="true"></div>

    <section class="grid" id="classGrid" aria-label="Upcoming classes"></section>

    <p style="margin-top:22px; font-size:14px; opacity:.9;">
      Need to purchase a plan or you’re new here? Use the Reserve form on the main site.
    </p>

    <p style="margin-top:10px;">
      <a class="btn" href="index.html">Back to home</a>
    </p>
  </main>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-backdrop" data-close="1"></div>

    <div class="modal-card">
      <h3 id="confirmTitle">Quick reminder</h3>

      <p><strong>Cancel at least 4 hours before class</strong> so someone else can grab the spot.</p>
      <p><strong>Please arrive 5 minutes early</strong> to get settled.</p>

      <div class="modal-actions">
        <button class="btn btn-ghost" type="button" id="cancelConfirm">Nevermind</button>
        <button class="btn" type="button" id="doConfirm">Confirm spot</button>
      </div>

      <p class="modal-note">By confirming, you agree to the cancellation policy.</p>
    </div>
  </div>

  <script src="assets/site.js?v=2"></script>

  <script>
  const RSVP_ENDPOINT = "https://script.google.com/macros/s/AKfycbyHqHeUS--cfAxGkbsD179aB8rhnTptirrAUZkp0BjXo5Ve7GY3GqOYKECngU0d1bFKHQ/exec";
  const TZ = 'America/Detroit';

  const params = new URLSearchParams(location.search);
  const memberId = params.get('id');

  const memberBadge = document.getElementById('memberBadge');
  memberBadge.textContent = memberId ? 'Checking member…' : 'Missing member link';

  // Validate member via lookup so we can display name/plan
  async function loadMember(){
    if (!memberId) return null;
    try{
      const url = new URL(RSVP_ENDPOINT);
      url.searchParams.set('action', 'lookup');
      url.searchParams.set('memberId', memberId);

      const res = await fetch(url.toString(), { method:'GET' });
      const data = await res.json().catch(()=> ({}));

      if (!res.ok || !data.ok || !data.found) return null;

      const m = data.member || {};
      memberBadge.textContent = (m.DisplayName ? m.DisplayName : 'Member') + (m.PlanType ? ` · ${m.PlanType}` : '');
      return m;
    }catch(_){
      return null;
    }
  }

  function weekdayNumFromName(name){
    const n = String(name || '').trim().toLowerCase();
    return {
      monday:1, mon:1,
      tuesday:2, tue:2, tues:2,
      wednesday:3, wed:3,
      thursday:4, thu:4, thur:4, thurs:4,
      friday:5, fri:5,
      saturday:6, sat:6,
      sunday:7, sun:7
    }[n] || 0;
  }

  function zonedParts(date){
    return new Intl.DateTimeFormat('en-US', { timeZone:TZ, year:'numeric', month:'numeric', day:'numeric' })
      .formatToParts(date).reduce((a,p)=>(a[p.type]=p.value,a),{});
  }

  function weekdayNumToday(d){
    const wd = new Intl.DateTimeFormat('en-US', { timeZone:TZ, weekday:'short' })
      .format(d).toLowerCase();
    return { mon:1, tue:2, wed:3, thu:4, fri:5, sat:6, sun:7 }[wd];
  }

  // Use "UTC noon trick" so date math is stable
  function utcNoon(y,m,d){ return new Date(Date.UTC(y, m-1, d, 12)); }
  function addDays(d,n){ return new Date(d.getTime() + n*86400000); }

  function formatDayPipe(d){
    const w  = new Intl.DateTimeFormat('en-US', { timeZone:TZ, weekday:'long' }).format(d);
    const md = new Intl.DateTimeFormat('en-US', { timeZone:TZ, month:'short', day:'numeric' }).format(d);
    return `${w} | ${md}`;
  }

  function timeRangeFromISO(startIso, endIso){
    const d1 = new Date(startIso);
    const d2 = new Date(endIso);

    const fmt = new Intl.DateTimeFormat('en-US', {
      timeZone: TZ,
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });

    const a = fmt.format(d1).toLowerCase().replace(/\s/g,'');
    const b = fmt.format(d2).toLowerCase().replace(/\s/g,'');
    // Convert "5:30pm" -> "5:30p"
    const short = (s) => s.replace('am','a').replace('pm','p');
    return `${short(a)}–${short(b)}`;
  }

  // Parse start time from "5:30p–6:00p" (en dash) or "5:30p-6:00p"
  function parseStartTime(timeRange){
    const raw = String(timeRange || '').trim().toLowerCase();
    const s = raw.replace(/[–—]/g,'-').replace(/\s+/g,'');
    const start = s.split('-')[0] || '';
    const m = start.match(/^(\d{1,2})(?::(\d{2}))?([ap])$/);
    if (!m) return null;

    let hh = parseInt(m[1],10);
    const mm = m[2] ? parseInt(m[2],10) : 0;
    const ap = m[3];

    if (ap === 'p' && hh !== 12) hh += 12;
    if (ap === 'a' && hh === 12) hh = 0;

    return { hh, mm };
  }

  // Build ISO string for Detroit local date+time (returns an ISO string with offset)
  async function detroitISOForDateAndTime(yyyyMmDd, hh, mm){
    const base = new Date(`${yyyyMmDd}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
    const fmt = new Intl.DateTimeFormat('en-US', {
      timeZone: TZ,
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit',
      hour12:false
    });
    const parts = fmt.formatToParts(base).reduce((a,p)=>(a[p.type]=p.value,a),{});
    const y = parts.year, mo = parts.month, d = parts.day;
    const H = parts.hour, M = parts.minute, S = parts.second;

    const detroitAsUTC = new Date(Date.UTC(+y, +mo-1, +d, +H, +M, +S));
    const offFmt = new Intl.DateTimeFormat('en-US', { timeZone: TZ, timeZoneName:'shortOffset' });
    const offParts = offFmt.formatToParts(detroitAsUTC);
    const tzName = (offParts.find(p=>p.type==='timeZoneName')||{}).value || 'GMT-00:00';
    const off = tzName.replace('GMT','').replace('UTC','') || '-00:00';
    const offset = off.includes(':') ? off : (off.length===3 ? off + ':00' : off);

    return `${y}-${mo}-${d}T${H}:${M}:${S}${offset}`;
  }

  async function fetchScheduleRows(){
    try{
      const url = new URL(RSVP_ENDPOINT);
      url.searchParams.set('action', 'schedule');

      const res = await fetch(url.toString(), { method:'GET' });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data.ok) return [];
      return Array.isArray(data.rows) ? data.rows : [];
    }catch(_){
      return [];
    }
  }

  function buildCardsFromScheduleRows(rows){
    // Map schedule rows by weekday number
    const byW = new Map();
    rows.forEach(r => {
      const wd = weekdayNumFromName(r.weekday);
      if (!wd) return;
      if (!byW.has(wd)) byW.set(wd, []);
      byW.get(wd).push({
        name: String(r.className || '').trim(),
        instructor: String(r.instructor || '').trim(),
        startISO: r.start,
        endISO: r.end
      });
    });

    // Sort each weekday by start time
    for (const [wd, list] of byW.entries()){
      list.sort((a,b) => {
        const ta = a.startISO ? new Date(a.startISO).getTime() : 0;
        const tb = b.startISO ? new Date(b.startISO).getTime() : 0;
        return ta - tb;
      });
      byW.set(wd, list);
    }

    // Build the current week (Mon–Sun)
    const now = new Date();
    const p = zonedParts(now);
    const today  = utcNoon(+p.year, +p.month, +p.day);
    const monday = addDays(today, -(weekdayNumToday(now)-1));

    const out = [];
    for (let i=0;i<7;i++){
      const date = addDays(monday, i);
      const ymd = date.toISOString().slice(0,10);
      const dayLabel = formatDayPipe(date);
      const wd = i+1;
      const classes = byW.get(wd) || [];

      for (const c of classes){
        const timeRange = (c.startISO && c.endISO)
          ? timeRangeFromISO(c.startISO, c.endISO)
          : '';

        // Keep your ClassID format: Name|YYYY-MM-DD|TimeRange
        const classId = `${c.name}|${ymd}|${timeRange}`;

        out.push({
          class_id: classId,
          class_name: c.name,
          instructor: c.instructor,
          time_range: timeRange,
          day_label: dayLabel,
          ymd
        });
      }
    }

    return out;
  }

  const grid = document.getElementById('classGrid');

  function renderCards(list){
    grid.innerHTML = '';
    list.forEach(item => {
      const card = document.createElement('article');
      card.className = 'card';

      const line = `${item.class_name} with ${item.instructor}, ${item.time_range}`;

      card.innerHTML = `
        <h3>${item.day_label}</h3>
        <p class="when">${line}</p>
        <div class="row">
          <span></span>
          <button class="btn small" type="button">Reserve</button>
        </div>
      `;

      card.querySelector('button').addEventListener('click', async () => {
        const t = parseStartTime(item.time_range);
        if (!t){
          alert('Could not parse class start time. Please contact Bodiodi.');
          return;
        }

        const classStartISO = await detroitISOForDateAndTime(item.ymd, t.hh, t.mm);

        onReserveClick({
          member_id: memberId,
          class_id: item.class_id,
          class_name: item.class_name,
          class_start_iso: classStartISO
        });
      });

      grid.appendChild(card);
    });

    if (!list.length){
      grid.innerHTML = `<p style="grid-column:1/-1; margin:8px 0 0 0; opacity:.85;">No upcoming classes right now. Please check back soon.</p>`;
    }
  }

  // Modal + save (unchanged)
  const modal = document.getElementById('confirmModal');
  const cancelBtn = document.getElementById('cancelConfirm');
  const confirmBtn = document.getElementById('doConfirm');
  let pendingReservation = null;

  function openConfirmModal(payload){
    pendingReservation = payload;
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeConfirmModal(){
    pendingReservation = null;
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
  }

  modal.addEventListener('click', (e) => {
    if (e.target && e.target.dataset && e.target.dataset.close) closeConfirmModal();
  });

  cancelBtn.addEventListener('click', closeConfirmModal);

  confirmBtn.addEventListener('click', async () => {
    if (!pendingReservation) return;

    if (!pendingReservation.member_id){
      alert('This reserve link is missing your member ID. Your personal link must include ?id=XXXX.');
      closeConfirmModal();
      return;
    }

    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Confirming…';

    try{
      const nowIso = new Date().toISOString();

      const payload = {
        member_id: pendingReservation.member_id,
        class_id: pendingReservation.class_id,
        class_name: pendingReservation.class_name || pendingReservation.class_id,
        class_start_iso: pendingReservation.class_start_iso,
        policy_confirmed: true,
        policy_confirmed_at: nowIso
      };

      const res = await fetch(RSVP_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok){
        const msg = (data && data.error) ? data.error : 'Sorry — something went wrong saving your reservation.';
        alert(msg);
        return;
      }

      alert('Reserved!');
      closeConfirmModal();

    } catch (err){
      console.error(err);
      alert('Network error saving your reservation. Please try again.');
    } finally{
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Confirm spot';
    }
  });

  function onReserveClick(payload){
    openConfirmModal(payload);
  }

  // Kick off member lookup + schedule fetch
  (async () => {
    const m = await loadMember();
    if (!m && memberId) memberBadge.textContent = 'Member link not found';
    if (!memberId) memberBadge.textContent = 'Missing member link';

    const rows = await fetchScheduleRows();
    const cards = buildCardsFromScheduleRows(rows);
    renderCards(cards);
  })();
</script>
</body>
</html>
